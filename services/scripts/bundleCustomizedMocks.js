// services/scripts/bundleCustomizedMocks.js
// Unified bundler for all 7 customized-mocks edge functions

import { build } from "esbuild";
import { writeFileSync, existsSync, mkdirSync } from "fs";
import { resolve, dirname } from "path";
import { fileURLToPath } from "url";

const __dirname = dirname(fileURLToPath(import.meta.url));
const servicesDir = resolve(__dirname, "..");
const rootDir = resolve(servicesDir, "..");

// Map of npm packages to Deno CDN URLs
const PACKAGE_MAP = {
    "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2",
    "openai": "https://esm.sh/openai@4",
    "uuid": "https://esm.sh/uuid@9",
    "zod": "https://esm.sh/zod@3",
};

// Define all 7 edge functions to bundle
const EDGE_FUNCTIONS = [
    {
        name: "customized-mocks-init",
        entryPoint: "workers/customized-mocks/functions/step1Init/handler.ts",
        outputDir: "supabase/functions/customized-mocks-init"
    },
    {
        name: "customized-mocks-passages",
        entryPoint: "workers/customized-mocks/functions/step2Passages/handler.ts",
        outputDir: "supabase/functions/customized-mocks-passages"
    },
    {
        name: "customized-mocks-rc-questions",
        entryPoint: "workers/customized-mocks/functions/step3RcQuestions/handler.ts",
        outputDir: "supabase/functions/customized-mocks-rc-questions"
    },
    {
        name: "customized-mocks-va-questions",
        entryPoint: "workers/customized-mocks/functions/step4VaQuestions/handler.ts",
        outputDir: "supabase/functions/customized-mocks-va-questions"
    },
    {
        name: "customized-mocks-select-answers",
        entryPoint: "workers/customized-mocks/functions/step5SelectAnswers/handler.ts",
        outputDir: "supabase/functions/customized-mocks-select-answers"
    },
    {
        name: "customized-mocks-rc-rationales",
        entryPoint: "workers/customized-mocks/functions/step6RcRationales/handler.ts",
        outputDir: "supabase/functions/customized-mocks-rc-rationales"
    },
    {
        name: "customized-mocks-va-rationales",
        entryPoint: "workers/customized-mocks/functions/step7VaRationales/handler.ts",
        outputDir: "supabase/functions/customized-mocks-va-rationales"
    }
];

function convertImportsToDeno(code) {
    let converted = code;

    // Replace package imports with CDN URLs
    for (const [pkg, url] of Object.entries(PACKAGE_MAP)) {
        // Match: from "@supabase/supabase-js"
        const fromRegex = new RegExp(
            `from\\s+["']${pkg.replace(/\//g, "\\/")}["']`,
            "g"
        );
        converted = converted.replace(fromRegex, `from "${url}"`);

        // Match: import "@supabase/supabase-js"
        const importRegex = new RegExp(
            `import\\s+["']${pkg.replace(/\//g, "\\/")}["']`,
            "g"
        );
        converted = converted.replace(importRegex, `import "${url}"`);

        // Match: import * as X from "@supabase/supabase-js"
        const importStarRegex = new RegExp(
            `import\\s+\\*\\s+as\\s+\\w+\\s+from\\s+["']${pkg.replace(
                /\//g,
                "\\/"
            )}["']`,
            "g"
        );
        converted = converted.replace(importStarRegex, (match) => {
            return match
                .replace(`"${pkg}"`, `"${url}"`)
                .replace(`'${pkg}'`, `"${url}"`);
        });
    }

    return converted;
}

async function bundleFunction(config) {
    const { name, entryPoint, outputDir } = config;
    
    console.log(`\nüî® Bundling ${name}...`);
    
    const entryPath = resolve(servicesDir, entryPoint);
    console.log(`üìç Entry: ${entryPoint}`);

    try {
        // Bundle the code
        const result = await build({
            entryPoints: [entryPath],
            bundle: true,
            platform: "neutral",
            format: "esm",
            target: "es2020",
            write: false,
            minify: false,
            sourcemap: false,
            mainFields: ["module", "main"],
            resolveExtensions: [".ts", ".js", ".json"],
            loader: {
                ".ts": "ts",
                ".js": "js",
            },
            logLevel: "warning",
        });

        // Get bundled code
        let bundledCode = result.outputFiles[0].text;

        // Convert imports
        bundledCode = convertImportsToDeno(bundledCode);

        // Add header
        const denoHeader = `// Auto-generated bundle for Deno Edge Runtime
// Generated: ${new Date().toISOString()}
// Function: ${name}
// DO NOT EDIT - This file is auto-generated by: npm run bundle:customized-mocks

`;

        bundledCode = denoHeader + bundledCode;

        // Ensure output directory exists
        const outputPath = resolve(rootDir, outputDir);
        if (!existsSync(outputPath)) {
            mkdirSync(outputPath, { recursive: true });
        }

        // Write bundled file
        const bundledFilePath = resolve(outputPath, "bundled.ts");
        writeFileSync(bundledFilePath, bundledCode, "utf-8");

        console.log(`‚úÖ ${name}: ${(bundledCode.length / 1024).toFixed(2)} KB`);
        
        return true;
    } catch (err) {
        console.error(`‚ùå ${name} failed:`, err.message);
        if (err.errors && err.errors.length > 0) {
            err.errors.forEach((e) => {
                console.error(`  ${e.text}`);
                if (e.location) {
                    console.error(
                        `    at ${e.location.file}:${e.location.line}:${e.location.column}`
                    );
                }
            });
        }
        return false;
    }
}

async function bundleAll() {
    console.log("üöÄ Bundling all customized-mocks edge functions...");
    console.log(`üìÇ Services dir: ${servicesDir}`);
    console.log(`üìÇ Root dir: ${rootDir}\n`);

    let successCount = 0;
    let failCount = 0;

    for (const config of EDGE_FUNCTIONS) {
        const success = await bundleFunction(config);
        if (success) {
            successCount++;
        } else {
            failCount++;
        }
    }

    console.log("\n" + "=".repeat(60));
    console.log(`‚úÖ Successfully bundled: ${successCount}/${EDGE_FUNCTIONS.length}`);
    if (failCount > 0) {
        console.log(`‚ùå Failed: ${failCount}`);
    }
    console.log("=".repeat(60));

    if (failCount === 0) {
        console.log("\nüì¶ All functions bundled successfully!");
        console.log("\nDeploy all with:");
        console.log("  supabase functions deploy customized-mocks-init");
        console.log("  supabase functions deploy customized-mocks-passages");
        console.log("  supabase functions deploy customized-mocks-rc-questions");
        console.log("  supabase functions deploy customized-mocks-va-questions");
        console.log("  supabase functions deploy customized-mocks-select-answers");
        console.log("  supabase functions deploy customized-mocks-rc-rationales");
        console.log("  supabase functions deploy customized-mocks-va-rationales");
    } else {
        process.exit(1);
    }
}

bundleAll();
