// services/scripts/bundle-edge-function.js
// Enhanced version with proper Deno import handling

import { build } from "esbuild";
import { writeFileSync, existsSync, mkdirSync, readFileSync } from "fs";
import { resolve, dirname } from "path";
import { fileURLToPath } from "url";

const __dirname = dirname(fileURLToPath(import.meta.url));
const servicesDir = resolve(__dirname, ".."); // scripts -> services
const rootDir = resolve(servicesDir, ".."); // services -> root

// Map of npm packages to Deno CDN URLs
const PACKAGE_MAP = {
	"@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2",
	openai: "https://esm.sh/openai@4",
};

function convertImportsToDeno(code) {
	let converted = code;

	// Replace package imports with CDN URLs
	for (const [pkg, url] of Object.entries(PACKAGE_MAP)) {
		// Match: from "@supabase/supabase-js"
		const fromRegex = new RegExp(
			`from\\s+["']${pkg.replace(/\//g, "\\/")}["']`,
			"g"
		);
		converted = converted.replace(fromRegex, `from "${url}"`);

		// Match: import "@supabase/supabase-js"
		const importRegex = new RegExp(
			`import\\s+["']${pkg.replace(/\//g, "\\/")}["']`,
			"g"
		);
		converted = converted.replace(importRegex, `import "${url}"`);

		// Match: import * as X from "@supabase/supabase-js"
		const importStarRegex = new RegExp(
			`import\\s+\\*\\s+as\\s+\\w+\\s+from\\s+["']${pkg.replace(
				/\//g,
				"\\/"
			)}["']`,
			"g"
		);
		converted = converted.replace(importStarRegex, (match) => {
			return match
				.replace(`"${pkg}"`, `"${url}"`)
				.replace(`'${pkg}'`, `"${url}"`);
		});
	}

	return converted;
}

async function bundleFunction() {
	try {
		console.log("ðŸ”¨ Bundling teach-concept function...");
		console.log("ðŸ“‚ Services dir:", servicesDir);
		console.log("ðŸ“‚ Root dir:", rootDir);
		console.log("");

		const entryPoint = resolve(
			servicesDir,
			"workers/daily-content/runDailyContent.ts"
		);
		console.log("ðŸ“ Entry point:", entryPoint);
		console.log("");

		// Check if file exists
		if (!existsSync(entryPoint)) {
			throw new Error(`Entry point not found: ${entryPoint}`);
		}

		// Check subdirectories
		// const subdirs = ["assembly", "config", "graph", "retrieval", "synthesis"];
		// console.log("ðŸ” Checking subdirectories...");
		// for (const dir of subdirs) {
		// 	const dirPath = resolve(
		// 		servicesDir,
		// 		"workers/daily-content",
		// 		dir
		// 	);
		// 	if (existsSync(dirPath)) {
		// 		console.log("  âœ…", dir);
		// 	} else {
		// 		console.log("  âš ï¸", dir, "(not found)");
		// 	}
		// }
		// console.log("");

		// Bundle the services code
		console.log("ðŸ“¦ Running esbuild...");
		const result = await build({
			entryPoints: [entryPoint],
			bundle: true,
			platform: "neutral",
			format: "esm",
			target: "es2020",
			write: false,
			minify: false,
			sourcemap: false,
			mainFields: ["module", "main"],
			resolveExtensions: [".ts", ".js", ".json"],
			loader: {
				".ts": "ts",
				".js": "js",
			},
			logLevel: "warning",
		});

		// Get the bundled code
		let bundledCode = result.outputFiles[0].text;

		// Convert npm imports to Deno CDN URLs
		console.log("ðŸ”„ Converting imports to Deno-compatible format...");
		bundledCode = convertImportsToDeno(bundledCode);

		// Add header
		const denoHeader = `// Auto-generated bundle for Deno Edge Runtime
// Generated: ${new Date().toISOString()}
// DO NOT EDIT - This file is auto-generated by: npm run bundle:edge

`;

		bundledCode = denoHeader + bundledCode;

		// Ensure output directory exists
		const outputDir = resolve(rootDir, "supabase/functions/teach-concept");
		if (!existsSync(outputDir)) {
			mkdirSync(outputDir, { recursive: true });
		}

		// Write to edge function folder
		const outputPath = resolve(outputDir, "bundled.ts");
		writeFileSync(outputPath, bundledCode, "utf-8");

		console.log("âœ… Bundle created:", outputPath);
		console.log("ðŸ“¦ Size:", (bundledCode.length / 1024).toFixed(2), "KB");
		console.log("");

		// Count imports
		const importMatches =
			bundledCode.match(/from ["']https:\/\/esm\.sh\//g) || [];
		console.log("ðŸ“š External dependencies:", importMatches.length);

		console.log("");
		console.log("Deploy with:");
		console.log("  cd .. && supabase functions deploy teach-concept");
	} catch (err) {
		console.error("âŒ Bundle failed:", err.message);
		if (err.errors && err.errors.length > 0) {
			console.error("\nBuild errors:");
			err.errors.forEach((e) => {
				console.error(`  ${e.text}`);
				if (e.location) {
					console.error(
						`    at ${e.location.file}:${e.location.line}:${e.location.column}`
					);
				}
			});
		}
		process.exit(1);
	}
}

bundleFunction();
